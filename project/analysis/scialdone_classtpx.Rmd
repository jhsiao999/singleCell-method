---
title: "Scialdone 2015 classtpx analysis"
author: "Kushal K Dey"
date: "February 18, 2016"
output: html_document
---

## Overview

In this script, we apply the `classtpx` model for classification of the datasets in Scialdone et al (2015), check [paper](http://www.sciencedirect.com/science/article/pii/S1046202315300098). The datasets used in this script are E-MTAB-3749 (FACS sorted data on G1, G2 and S cells) and  E-MTAB-3707 (liver data). 

## Data reading 

```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
library(data.table)
G1_data <- read.table("../data/Scialdone2015data/G1_htseq_count.txt");
G2M_data <- read.table("../data/Scialdone2015data/G2M_htseq_count.txt");
S_data <- read.table("../data/Scialdone2015data/S_htseq_count.txt");

liver_data <- data.frame(fread("../data/Scialdone2015data/Marioni_lab_1_Jul_2015_gene_counts_table.txt"));

facs_data <- cbind.data.frame(G1_data[,1], G1_data[,2], G2M_data[,2], S_data[,2]);
colnames(facs_data) <- c("genes", "G1.counts", "G2M.counts", "S.counts");

indices_intersect <- intersect(facs_data[,1], liver_data[,1])

matched_liver <-  match(indices_intersect, liver_data[,1])
liver_data_mod <- liver_data[matched_liver,-1];
rownames(liver_data_mod) <- indices_intersect;

matched_facs <- match(indices_intersect, facs_data[,1])
facs_data_mod <- facs_data[matched_facs,-1];
rownames(facs_data_mod) <-  indices_intersect;

data_mod <- cbind(facs_data_mod, liver_data_mod);

counts <- t(data_mod);
is.na(ercc_start <- grep("ERCC", rownames(data_mod))[1])
```

## classtpx model fit

Now we apply the `classtpx` model fixing the first three rows to the cell types $G1$, $G2M$ and $S$. 

```{r echo=TRUE, eval=TRUE}
library(classtpx)
K <- 3;
known_indices <- 1:3;
omega_known <- rbind(c(1,0,0), c(0,1,0), c(0,0,1));
Topic_clus <- classtpx::class_topics(counts, K, known_indices = known_indices, omega_known = omega_known, tol=0.001);

```


```{r structure_pooled, echo=TRUE, eval=TRUE}
samp_metadata <- cbind.data.frame(c("G1", "G2", "S", 1:96));
colnames(samp_metadata) <- c("cycle_phase");

if(!dir.exists("../figures/scialdone_structure")) dir.create("../figures/scialdone_structure")

library(CountClust)
obj <- StructureObj_omega(Topic_clus$omega, samp_metadata = samp_metadata, batch_lab = NULL,partition = rep("TRUE",dim(samp_metadata)[2]),path_struct="../figures/scialdone_structure",control=list(cex.axis=1));

  
```

The Structure plots clearly show cell phase effects

<img src='../figures/scialdone_structure/clus_3/struct_clus_3_cycle_phase.png' style="width:350px;height:300px;">
