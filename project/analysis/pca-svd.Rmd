---
title: "PCA and SVD in R"
author: "Joyce Hsiao"
date: "2016-02-12"
output: 
  html_document:
    css: floating-toc.css
    toc: true
---

## Background and objectives

Principal component analysis is frequently used as a tool in exploratory data analysis of genomics data. We can compute pricipal component scores and pricipal component loadings in R using *stats::prcomp* or *base::svd*. Here we lay out codes for visualizing data with PCA analysis using both functions. 

Note that an important issue in PCA visualization is whether to scale the variables to unit variances. PCA analysis on unit variances versus on raw variances often yields different pricipal
component scores. 


## References

[stackexchange](http://stats.stackexchange.com/questions/105592/not-normalizing-data-before-pca-gives-better-explained-variance-ratio)

[Irizarry's lab on running PCA and SVD in R](http://genomicsclass.github.io/book/pages/pca_svd.html)

[Leek's lab on running PCA and SVD in R](https://github.com/jtleek/dataanalysis/blob/master/week3/006dimensionReduction/index.md)


## Computational steps

1. Import data as gene x sample

2. Exclude samples with total 0 counts

3. Transform raw counts to log2(10^6*count/depth + 1)

4. Tanspose data to sample x gene

5. Mean-center each gene vector

6. Compute PC scores and PC loadings


## Load packages

*gmodels* provides faster versions of both svd and pca. 

```{r}
library("edgeR")
require(matrixStats)
library("gmodels")
```


## Prepare data

Import a subset cells in [Jaitin2014][Jaitin2014] UMI counts as an example.

[Jaitin2014]: https://dx.doi.org/10.1126/science.1247651


```{r}
jaitin_data <- read.table("../data/jaitin-2014/GSE54006_umitab.txt", header = TRUE,
                           stringsAsFactors = FALSE, sep = "\t")
rownames(jaitin_data) <- jaitin_data[ ,1]
jaitin_data <- jaitin_data[,-1]
```

Import 50 cells.

```{r}
jaitin_subset <- jaitin_data[ , 1:50]
```

Filter samples with 0 count.

```{r}
jaitin_subset <- jaitin_subset[ , colSums(jaitin_subset) != 0]
```

log2(10^6*count/depth + 1)

```{r}
jaitin_log2cpm <- log2( (10^6 * sweep(jaitin_subset, 
                                        MARGIN = 2,
                                        STATS = colSums(jaitin_subset),
                                        FUN = "/") ) + 1)
```

Transpose data.

```{r}
jaitin_log2cpm_transpose <- t(jaitin_log2cpm)
```


## Raw variances, mean-center gene vectors

PCA 

```{r}
pca_raw <- gmodels::fast.prcomp(jaitin_log2cpm_transpose, 
                                retx = TRUE, 
                                center = TRUE, 
                                scale. = FALSE)
str(pca_raw)
```

SVD

```{r}
svd_raw <- gmodels::fast.svd( scale(jaitin_log2cpm_transpose, 
                                    scale = FALSE) )
str(svd_raw)
```

### Principal component loadings

```{r}
cbind(pca_raw$x[ ,1], svd_raw$u[ ,1])
par(mfrow = c(1,2))
plot(pca_raw$x[,1], pca_raw$x[,2], col = 1:10, pch = 3)
plot(svd_raw$u[,1], svd_raw$u[,2], col = 1:10, pch = 3)
title(main = "PC loadings", outer = TRUE)
```


### Percent variance explained

```{r}
scores_pca_raw <- round( (pca_raw$sdev^2)/sum(pca_raw$sdev^2), 4)
scores_svd_raw <- round( (svd_raw$d^2)/sum(svd_raw$d^2), 4)
cbind(scores_pca_raw, scores_svd_raw)
```

### Rotation

```{r}
pca_raw$rotation[1:3, 1:3]
svd_raw$v[1:3, 1:3]
```



## Unit variance versus raw variance

Raw variance case

```{r}
pca_raw <- gmodels::fast.prcomp(jaitin_log2cpm_transpose, 
                                retx = TRUE, 
                                center = TRUE, 
                                scale. = FALSE)
str(pca_raw)
```

Unit variance case. Variable sums (column) need to be greater than 0.

```{r}
jaitin_log2cpm_transpose_filter <- 
    jaitin_log2cpm_transpose[ , colSums(jaitin_log2cpm_transpose) != 0]
pca_unit <- gmodels::fast.prcomp(jaitin_log2cpm_transpose_filter, 
                                 retx = TRUE, 
                                 center = TRUE, 
                                 scale. = TRUE)
str(pca_unit)
```


### Principal component loadings

PC coordiantes are different under these scenarios.

```{r}
cbind(pca_raw$x[ ,1], pca_unit$x[ ,1])
par(mfrow = c(1,2))
plot(pca_raw$x[,1], pca_raw$x[,2], col = 1:10, pch = 3,
     main = "Raw variances")
plot(pca_unit$x[,1], pca_unit$x[,2], col = 1:10, pch = 3,
     main = "Unit Variances")
title(main = "PC loadings", outer = TRUE, line = -1)
```

But the rankings are the same!
 
```{r}
par(mfrow = c(1,2))
plot(rank(pca_raw$x[,1]), rank(pca_raw$x[,2]), col = 1:10, pch = 3,
     main = "Raw variances")
plot(rank(pca_unit$x[,1]), rank(pca_unit$x[,2]), col = 1:10, pch = 3,
     main = "Unit Variances")
title(main = "PC loading rankings", outer = TRUE, line = -1)
```


### Percent variance explained

Percent variance explained by each PC component is not the same after we transform raw variances to unit variances. 

```{r}
scores_pca_raw <- round( (pca_raw$sdev^2)/sum(pca_raw$sdev^2), 4)
scores_pca_unit <- round( (pca_unit$sdev^2)/sum(pca_unit$sdev^2), 4)
cbind(scores_pca_raw, scores_pca_unit)
```

### Rotation

Rotation parameters are also different. 

```{r}
round(pca_raw$rotation[1:3, 1:3], 4)
round(pca_unit$rotation[1:3, 1:3], 4)
```



