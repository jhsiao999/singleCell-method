---
title: "RUVg"
author: Joyce Hsiao
date: "2015-11-24"
output: 
  html_document:
    css: floating-toc.css
    toc: true
---

## Goal

Apply RUVg and check the whether the first PC of ERCC is highly correlated with totl mapped reads. 

Use RUVg from [Risso et al., 2014][Risso2014], k = 1.
It uses the ERCC spike-ins as negative control genes to correct for unwanted variation.
It uses counts as input and output.
It requires one parameter to be chosen:
`k` is the "number of factors of unwanted variation to be estimated from the data".

[Risso2014]: http://www.nature.com/nbt/journal/v32/n9/full/nbt.2931.html



## Set up

```{r, message=FALSE, warning=FALSE}
library(RUVSeq)
library(edgeR)

library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(message = FALSE, warning = FALSE, eval = TRUE, 
               echo = TRUE)

source("../R/functions.R")
```


## Prepare data

Import filtered molecule count data.

```{r}
molecules_filter <- read.table("../data/molecules-filter.txt",
                               header = TRUE, sep = "\t",
                               stringsAsFactors = FALSE,
                               row.names = 1)
head(molecules_filter[1:2, 1:5])
```

Select ERCC genes

```{r}
molecules_ercc <- molecules_filter[ grep("ERCC", rownames(molecules_filter)), ]
```


Import filtered molecule CPM ERCC data.

```{r}
molecules_cpm_ercc <- read.table("../data/molecules-cpm-ercc.txt",
                               header = TRUE, sep = "\t",
                               stringsAsFactors = FALSE,
                               row.names = 1)
head(molecules_cpm_ercc[1:2, 1:5])
```


Import annotation infomration fo the filtered data

```{r}
annotation_filter <- read.table("../data/annotation-filter.txt",
                                header = TRUE, sep = "\t",
                                stringsAsFactors = FALSE)
head(annotation_filter)
stopifnot(NCOL(molecules_filter) == NROW(annotation_filter))
```




## RUV-normalized counts

```{r ruv-k1}
molecule_ruv_k1 <- RUVg(x = as.matrix(molecules_filter), 
                        cIdx = grep("ERCC", rownames(molecules_filter)), 
                        k = 1)

molecule_counts_ruv_k1 <- molecule_ruv_k1$normalizedCounts
molecule_counts_ruv_k1[1:2, 1:5]
```


### ERCC PCA before normalization

```{r pca-ruv-k1-ercc}
log2counts_ercc <- log2(as.matrix(molecules_filter[ grep("ERCC", rownames(molecules_filter) ), ]) + 1)

pca_counts_ercc <- run_pca( log2counts_ercc )
plot_pca(pca_counts_ercc$PCs, explained = pca_counts_ercc$explained,
         metadata = annotation_filter, color = "individual",
         shape = "replicate", factors = c("individual", "replicate"))
```


### ENSG PCA

```{r pca-ruv-k1}
log2counts <- log2(molecule_counts_ruv_k1[ 
                 grep("ERCC", rownames(molecule_counts_ruv_k1), invert = TRUE), ])
log2counts <- log2counts[rowSums(log2counts) > 0, ]

pca_counts_ruv_k1 <- run_pca( log2counts )
plot_pca(pca_counts_ruv_k1$PCs, explained = pca_counts_ruv_k1$explained,
         metadata = annotation_filter, color = "individual",
         shape = "replicate", factors = c("individual", "replicate"))
```





## RUV + CPM normalized counts

```{r ruv-k1-cpm}
molecule_cpm_ruv_k1 <- cpm(molecule_counts_ruv_k1, log = TRUE)
```


```{r pca-ruv-k1-cpm}
pca_cpm_ruv_k1 <- 
    run_pca( (molecule_cpm_ruv_k1[ 
             grep("ERCC", rownames(molecule_cpm_ruv_k1), invert = TRUE), ]) )
plot_pca(pca_cpm_ruv_k1$PCs, explained = pca_cpm_ruv_k1$explained,
         metadata = annotation_filter, color = "individual",
         shape = "replicate", factors = c("individual", "replicate"))
```


## Session information

```{r info}
sessionInfo()
```
