---
title: "ERCC genes PCA"
author: "Joyce Hsiao"
date: "2015-11-12"
output: 
  html_document:
    css: floating-toc.css
    toc: true
---


## Goal

ERCC genes are expected to remain in constant expression levels across samples. We are curious about the sample characteristic that drives the first PC in the ERCC genes.

## Summary

The first PC in the ERCC genes is the individual difference between NA19098 and the other two individuals; and the PC1 loading is highly correlated with total ERCC molecule counts. 


## Prepare data

Import filtered molecule count data.

```{r}
molecules_filter <- read.table("../data/molecules-filter.txt",
                               header = TRUE, sep = "\t",
                               stringsAsFactors = FALSE,
                               row.names = 1)
head(molecules_filter[1:2, 1:5])
```

Select ERCC genes

```{r}
molecules_ercc <- molecules_filter[ grep("ERCC", rownames(molecules_filter)), ]
```


Import filtered molecule CPM ERCC data.

```{r}
molecules_cpm_ercc <- read.table("../data/molecules-cpm-ercc.txt",
                               header = TRUE, sep = "\t",
                               stringsAsFactors = FALSE,
                               row.names = 1)
head(molecules_cpm_ercc[1:2, 1:5])
```


Import annotation infomration fo the filtered data

```{r}
annotation_filter <- read.table("../data/annotation-filter.txt",
                                header = TRUE, sep = "\t",
                                stringsAsFactors = FALSE)
head(annotation_filter)
stopifnot(NCOL(molecules_filter) == NROW(annotation_filter))
```




## PCA of ERCC molecule counts


```{r, fig.width=12,fig.height=12}
library(testit)
pca_ercc <- prcomp(t(molecules_ercc), retx = TRUE, center = TRUE, scale. = TRUE )

library(ggplot2)
library(gridExtra)
grid.arrange(ggplot(data.frame(x = pca_ercc$x[,1], 
                              y = pca_ercc$x[,2],
                              individual = annotation_filter$individual,
                              replicate = annotation_filter$replicate),
                               aes(x = x, y = y, color = individual) ) +
                        geom_point() +
                        xlab("PC1") + ylab("PC2"), 
              ggplot(data.frame(x = pca_ercc$x[,2], 
                                  y = pca_ercc$x[,3],
                                  individual = annotation_filter$individual,
                                  replicate = annotation_filter$replicate),
                                   aes(x = x, y = y, color = individual) ) +
                    geom_point() +
                    xlab("PC2") + ylab("PC3"),
                ggplot(data.frame(x = pca_ercc$x[,1], 
                                  y = pca_ercc$x[,3],
                                  individual = annotation_filter$individual,
                                  replicate = annotation_filter$replicate),
                                   aes(x = x, y = y, color = individual) ) +
                    geom_point() +
                    xlab("PC1") + ylab("PC3"),
          nrow = 2, ncol = 2)
```


First PC versus ERCC total molecule counts.

```{r}
ggplot(data.frame(pc1 = pca_ercc$x[, 1],
                  ercc_total_counts = colSums(molecules_ercc),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate),
       aes(x = pc1, y = ercc_total_counts,
           color = individual,
           shape = replicate)) +
    geom_point()
```

First PC first total ERCC + Endogenous gene counts.

```{r}
ggplot(data.frame(pc1 = pca_ercc$x[, 1],
                  ercc_total_counts = colSums(molecules_filter),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate),
       aes(x = pc1, y = ercc_total_counts,
           color = individual,
           shape = replicate)) +
    geom_point()
```


## Total molecule counts


### Of all genes.

```{r}
ggplot(data.frame(total_count = colSums(molecules_filter),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate,
                  batch = annotation_filter$batch,
                  sample_id = annotation_filter$sample_id),
       aes(x = factor(sample_id), y = total_count,
           fill = factor(individual)) ) +
    geom_bar(stat = "identity")
```


### Of ERCC genes.

```{r}
ggplot(data.frame(total_count = colSums(molecules_ercc),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate,
                  batch = annotation_filter$batch,
                  sample_id = annotation_filter$sample_id),
       aes(x = factor(sample_id), y = total_count,
           fill = factor(individual)) ) +
    geom_bar(stat = "identity")
```



## PCA of ERCC log2CPM


```{r, fig.width=12,fig.height=12}
library(testit)
pca_ercc_cpm <- prcomp(t(molecules_cpm_ercc), retx = TRUE, 
                       center = TRUE, scale. = TRUE )

library(ggplot2)
library(gridExtra)
grid.arrange(ggplot(data.frame(x = pca_ercc_cpm$x[,1], 
                              y = pca_ercc_cpm$x[,2],
                              individual = annotation_filter$individual,
                              replicate = annotation_filter$replicate),
                               aes(x = x, y = y, color = individual) ) +
                        geom_point() +
                        xlab("PC1") + ylab("PC2"), 
              ggplot(data.frame(x = pca_ercc_cpm$x[,2], 
                                  y = pca_ercc_cpm$x[,3],
                                  individual = annotation_filter$individual,
                                  replicate = annotation_filter$replicate),
                                   aes(x = x, y = y, color = individual) ) +
                    geom_point() +
                    xlab("PC2") + ylab("PC3"),
                ggplot(data.frame(x = pca_ercc_cpm$x[,1], 
                                  y = pca_ercc_cpm$x[,3],
                                  individual = annotation_filter$individual,
                                  replicate = annotation_filter$replicate),
                                   aes(x = x, y = y, color = individual) ) +
                    geom_point() +
                    xlab("PC1") + ylab("PC3"),
          nrow = 2, ncol = 2)
```



PC1 of ERCC log2CPM data versus total ERCC counts.

```{r}
ggplot(data.frame(pc1 = pca_ercc_cpm$x[, 1],
                  ercc_total_counts = colSums(molecules_ercc),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate),
       aes(x = pc1, y = ercc_total_counts,
           color = individual,
           shape = replicate)) +
    geom_point()
```


PC1 of ERCC log2CPM data versus total molecule counts (endogenous + ERCC).

```{r}
ggplot(data.frame(pc1 = pca_ercc_cpm$x[, 1],
                  ercc_total_counts = colSums(molecules_filter),
                  individual = annotation_filter$individual,
                  replicate = annotation_filter$replicate),
       aes(x = pc1, y = ercc_total_counts,
           color = individual,
           shape = replicate)) +
    geom_point()
```



## Session information
```{r}

```

